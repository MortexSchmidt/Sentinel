<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sentinel Lua — Купить лицензию</title>
  <link rel="stylesheet" href="/style.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
</head>
<body>
  <div class="webapp-container auth-page">
    <div class="app-shell">
      <aside class="app-sidebar" aria-label="Навигация">
        <div class="app-logo" title="Sentinel">
          <img src="https://i.ibb.co/gL8qpGRB/image-removebg-preview.png" alt="Sentinel logo" class="app-logo-img">
        </div>
        <nav class="sidebar-nav">
          <button class="sidebar-btn active" title="Store" aria-label="Store">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M3 7h18v13H3z" stroke="#9aa4b2" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round" fill="none"/><path d="M16 7V5a4 4 0 10-8 0v2" stroke="#9aa4b2" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </button>
          <button class="sidebar-btn" title="Visuals" aria-label="Visuals">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M3 21l3-3 7-7 4 4-7 7-3 3H3z" stroke="#9aa4b2" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg>
          </button>
          <button class="sidebar-btn" title="Anti-Aim" aria-label="Anti-Aim">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M12 2l7 4v6c0 5-3.5 9.7-7 10-3.5-.3-7-5-7-10V6l7-4z" stroke="#9aa4b2" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg>
          </button>
          <button class="sidebar-btn" title="Ragebot" aria-label="Ragebot">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M13 2L3 14h7l-1 8 10-12h-7l1-8z" stroke="#9aa4b2" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg>
          </button>
          <button class="sidebar-btn" title="Configs" aria-label="Configs">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M12 15.5a3.5 3.5 0 100-7 3.5 3.5 0 000 7z" stroke="#9aa4b2" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" fill="none"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 01-2.83 2.83l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09a1.65 1.65 0 00-1-1.51 1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09c.67 0 1.24-.4 1.51-1a1.65 1.65 0 00-.33-1.82L3.3 4.7A2 2 0 016.1 1.87l.06.06A1.65 1.65 0 008 2.26c.67 0 1.24.4 1.51 1a1.65 1.65 0 001.82.33H12a1.65 1.65 0 001.51-1c.27-.6.84-1 1.51-1H18a2 2 0 010 4h-.09c-.67 0-1.24.4-1.51 1a1.65 1.65 0 00.33 1.82L19.4 8a2 2 0 012.83 2.83l-.06.06a1.65 1.65 0 00-1.82.33c-.27.6-.84 1-1.51 1H15a1.65 1.65 0 00-1.51 1c-.27.6-.84 1-1.51 1H9a2 2 0 010 4h.09c.67 0 1.24.4 1.51 1z" stroke="#9aa4b2" stroke-width="0.6" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg>
          </button>
        </nav>
      </aside>

      <div class="webapp-main">
        <div class="app-topbar">
          <div class="topbar-left">
              <div class="topbar-title-block">
                <h1 class="webapp-title">Sentinel Lua</h1>
                <div class="webapp-subtitle">Купить лицензию</div>
              </div>
            </div>
          <div class="topbar-right">
            <div id="headerUserMeta" class="header-user-meta">User: <span id="headerUser">Гость</span> <span class="dot">•</span> Expires: <span id="headerExpiry">-</span></div>
          </div>
        </div>

        <div class="webapp-content">
      <div id="loginScreen" class="auth-screen">
        <div class="auth-card">
            <!-- Brand: logo + product name centered at top of auth card -->
            <div class="auth-brand" aria-hidden="false">
                <!-- success message injected programmatically to prevent accidental default visibility -->
            </div>

            <div class="auth-header">
              <h2>Вход в систему</h2>
              <p class="auth-subtitle">Войдите через Telegram для доступа к магазину</p>
            </div>

          <div class="user-profile-preview">
            <div class="avatar-wrapper">
              <div class="avatar-placeholder"></div>
            </div>
            <div class="user-details">
              <div class="preview-name">Гость</div>
              <div class="preview-username">@guest</div>
              <div class="preview-status">Требуется авторизация</div>
              <div class="preview-chat">Chat ID: <span id="previewChatId"></span></div>
            </div>
          </div>

          
          <div class="auth-actions">
            <button id="authBtn" class="btn-primary auth-btn" onclick="__authClick()">Войти через Telegram</button>
          </div>
            <script>
            // Inline fallback: will call main handler if present, otherwise generate & show a non-closable code modal
            window.__authClick = function() {
              try {
                // If page already recorded successful auth, don't open a new modal
                if (window.__authCompleted || (document.getElementById('authSuccessActions') && document.getElementById('authSuccessActions').style.display !== 'none')) {
                  try { alert('Авторизация уже выполнена.'); } catch (e) { /* ignore */ }
                  return;
                }
                if (window.handleAuthBtnClick) { window.handleAuthBtnClick(); return; }
                // generate 6-digit code
                const code = Math.floor(Math.random() * 900000 + 100000).toString();
                // persist code first
                localStorage.setItem('pendingAuthCode', code);

                // If success already happened in another tab or process, abort creating modal
                if (window.__authCompleted || (document.getElementById('authSuccessActions') && document.getElementById('authSuccessActions').style.display !== 'none')) {
                  return;
                }

                // create a non-closable modal (no Close / Copy buttons). The command is copied automatically.
                let fm = document.getElementById('fallbackAuthModal');
                if (!fm) {
                  fm = document.createElement('div'); fm.id = 'fallbackAuthModal';
                  fm.style.position = 'fixed'; fm.style.inset = '0'; fm.style.display = 'flex'; fm.style.alignItems = 'center'; fm.style.justifyContent = 'center'; fm.style.background = 'rgba(0,0,0,0.6)'; fm.style.zIndex = '2147483655';
                  fm.innerHTML = '<div id="fallbackAuthInner" style="background:#0d1114;color:white;padding:20px;border-radius:12px;text-align:center;min-width:260px;max-width:420px;"><h3 style="margin:0 0 8px 0;">Код авторизации</h3><div id="fallbackCode" style="font-size:28px;font-weight:700;margin:12px 0;"></div><div id="fallbackCopyNote" style="font-size:13px;color:rgba(255,255,255,0.7);margin-top:8px;">Код будет автоматически скопирован в буфер обмена.</div><div style="margin-top:8px;color:rgba(255,255,255,0.5);font-size:13px;">Отправьте команду боту: <code id="fallbackCommand" style="background:rgba(255,255,255,0.02);padding:4px 8px;border-radius:6px;">/auth </code></div></div>';
                  document.body.appendChild(fm);
                  // lock modal so it can't be removed by other fallbacks
                  fm.dataset.locked = 'true';
                  // add emergency clear button into fallback modal
                  try {
                    const inner = document.getElementById('fallbackAuthInner') || fm;
                    const clearFallback = document.createElement('button');
                    clearFallback.id = 'forceClearFallbackBtn';
                    clearFallback.className = 'btn-secondary';
                    clearFallback.textContent = 'Сбросить';
                    clearFallback.style.display = 'none';
                    clearFallback.style.marginTop = '12px';
                    clearFallback.addEventListener('click', () => {
                      try { localStorage.removeItem('pendingAuthCode'); } catch (e) {}
                      try { fm.remove(); } catch (e) {}
                    });
                    inner.appendChild(clearFallback);
                    setTimeout(() => { try { if (!window.__authCompleted) clearFallback.style.display = 'inline-block'; } catch (e) {} }, 12000);
                  } catch (e) { /* ignore fallback emergency creation failures */ }
                }
                const disp = document.getElementById('fallbackCode'); if (disp) disp.textContent = code;
                const cmdEl = document.getElementById('fallbackCommand'); if (cmdEl) cmdEl.textContent = '/auth ' + code;

                // attempt to copy the full command into clipboard
                try {
                  navigator.clipboard.writeText('/auth ' + code).then(() => {
                    const note = document.getElementById('fallbackCopyNote'); if (note) note.textContent = 'Команда скопирована в буфер обмена.';
                  }).catch(() => {
                    const note = document.getElementById('fallbackCopyNote'); if (note) note.textContent = 'Не удалось автоматически скопировать. Скопируйте вручную: /auth ' + code;
                  });
                } catch (e) { /* ignore clipboard errors */ }

                // try to register on server (best-effort) and start client-side polling if available
                fetch('/auth/register', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({code}) }).then(r=>r.json()).then(j=>{
                  console.log('fallback auth register', j);
                  if (window.startAuthStatusCheck) {
                    try { window.startAuthStatusCheck(); } catch(e) { console.warn('startAuthStatusCheck not available', e); }
                  }
                }).catch(err=>{
                  console.error('fallback register err', err);
                  if (window.startAuthStatusCheck) {
                    try { window.startAuthStatusCheck(); } catch(e) { console.warn('startAuthStatusCheck failed', e); }
                  }
                });
              } catch (e) { console.error('[auth] fallback error', e); }
            };
          </script>
                <p class="success-message">Авторизация выполнена успешно!</p>
              </div>
            </div>
          </div>

          <div class="auth-note">
            <p>После авторизации вы получите доступ к покупке и подарку подписок</p>
          </div>
        </div>
      </div>

    <div id="mainScreen" class="screen hidden">
      <header class="main-header">
        <div class="profile">
          <div class="avatar-wrap"><img id="avatar" src="" alt="avatar" class="avatar hidden"></div>
          <div class="meta">
            <div id="name" class="name">Гость</div>
            <div id="username" class="username">@guest</div>
          </div>
        </div>
        <div id="status" class="status">Статус: <span id="planStatus">Нет подписки</span></div>
      </header>

      <section class="shop">
        <div id="plans" class="plans grid-plans"></div>
        <div id="selectedPlanActions" class="purchase-actions">
          <div id="selectedPlanInfo" class="selected-plan-info" style="margin-bottom:12px;color:var(--text-secondary);"></div>
        </div>
      </section>

  <p class="note">Выберите тариф — появится кнопка «Купить» внизу экрана.</p>
    </div>

    <!-- Providers area (hidden until Buy pressed) -->
    <div id="providersArea" class="providers-area hidden">
      <div class="providers-inner">
        <h3>Выберите провайдера оплаты</h3>
        <div id="providers" class="providers-list"></div>
        <div class="modal-actions">
          <button id="providersBack" class="ghost">Назад</button>
        </div>
      </div>
    </div>

    <!-- Success overlay -->
    <div id="successOverlay" class="success-overlay hidden">
      <div class="success-card">
        <h3>Покупка завершена</h3>
        <div id="successInfo"></div>
        <div class="modal-actions">
          <button id="closeSuccess" class="primary">Закрыть</button>
        </div>
      </div>
    </div>
  </div> <!-- .card -->

        </div> <!-- .webapp-content -->
      </div> <!-- .webapp-main -->
      <div class="sidebar-backdrop" tabindex="-1" aria-hidden="true"></div>
    </div> <!-- .app-shell -->
  </div> <!-- .webapp-container -->

  <audio id="sndClick" src="/sounds/click.mp3" preload="auto"></audio>
  <audio id="sndSuccess" src="/sounds/success.mp3" preload="auto"></audio>

  <script src="/main.js"></script>
  <div id="selectionBackdrop" class="selection-backdrop hidden" aria-hidden="true"></div>
  <button id="floatingBuyBtn" class="floating-buy" aria-hidden="true">Купить</button>
</body>
</html>
